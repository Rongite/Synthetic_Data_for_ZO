#!/usr/bin/env python3
"""
è®­ç»ƒç»“æœç®¡ç†å·¥å…·
åˆ—å‡ºå¹¶ç»„ç»‡Results_v2ç›®å½•ä¸‹çš„æ‰€æœ‰è®­ç»ƒç»“æœ
"""

import os
import yaml
from pathlib import Path
from typing import Dict, List
from datetime import datetime
from collections import defaultdict

PROJECT_ROOT = "/home/ubuntu/LLM-inference/jikai-project/Synthetic_Data_for_ZO"


class ResultsManager:
    def __init__(self):
        self.project_root = Path(PROJECT_ROOT)
        self.results_base = self.project_root / "Results_v2"

    def scan_results(self) -> Dict[str, List[Dict]]:
        """
        æ‰«æResults_v2ç›®å½•ï¼Œè¿”å›æŒ‰å®éªŒç›®çš„åˆ†ç»„çš„ç»“æœ

        Returns:
            {
                experiment_purpose: [
                    {
                        'model': str,
                        'experiment_name': str,
                        'timestamp': str,
                        'path': Path,
                        'config': Dict
                    },
                    ...
                ],
                ...
            }
        """
        if not self.results_base.exists():
            return {}

        results_by_purpose = defaultdict(list)

        # éå†å®éªŒç›®çš„ç›®å½•
        for purpose_dir in self.results_base.iterdir():
            if not purpose_dir.is_dir():
                continue

            purpose = purpose_dir.name

            # éå†æ¨¡å‹ç›®å½•
            for model_dir in purpose_dir.iterdir():
                if not model_dir.is_dir():
                    continue

                model = model_dir.name

                # éå†å®éªŒç›®å½• ({Task}_{Method}_{DataType}_{LR})
                for exp_dir in model_dir.iterdir():
                    if not exp_dir.is_dir():
                        continue

                    exp_name = exp_dir.name

                    # éå†æ—¶é—´æˆ³ç›®å½•
                    for timestamp_dir in exp_dir.iterdir():
                        if not timestamp_dir.is_dir():
                            continue

                        timestamp = timestamp_dir.name

                        # è¯»å–é…ç½®æ–‡ä»¶
                        config_path = timestamp_dir / "experiment_config.yaml"
                        config = None
                        if config_path.exists():
                            try:
                                with open(config_path, 'r', encoding='utf-8') as f:
                                    config = yaml.safe_load(f)
                            except Exception as e:
                                print(f"âš ï¸  æ— æ³•è¯»å–é…ç½®: {config_path}: {e}")

                        results_by_purpose[purpose].append({
                            'model': model,
                            'experiment_name': exp_name,
                            'timestamp': timestamp,
                            'path': timestamp_dir,
                            'config': config
                        })

        # å¯¹æ¯ä¸ªpurposeä¸‹çš„ç»“æœæŒ‰æ—¶é—´æˆ³æ’åº
        for purpose in results_by_purpose:
            results_by_purpose[purpose].sort(key=lambda x: x['timestamp'], reverse=True)

        return dict(results_by_purpose)

    def print_results_summary(self):
        """æ‰“å°ç»“æœæ‘˜è¦"""
        results = self.scan_results()

        if not results:
            print("ğŸ“‚ Results_v2 ç›®å½•ä¸ºç©º")
            return

        print("\n" + "="*80)
        print("è®­ç»ƒç»“æœæ‘˜è¦ - Results_v2")
        print("="*80)

        total_experiments = 0
        for purpose, experiments in sorted(results.items()):
            total_experiments += len(experiments)

            print(f"\nğŸ“ å®éªŒç›®çš„: {purpose}")
            print(f"   å®éªŒæ•°é‡: {len(experiments)}")

            # æŒ‰æ¨¡å‹åˆ†ç»„ç»Ÿè®¡
            by_model = defaultdict(int)
            for exp in experiments:
                by_model[exp['model']] += 1

            for model, count in sorted(by_model.items()):
                print(f"   â””â”€ {model}: {count} ä¸ªå®éªŒ")

        print(f"\n{'='*80}")
        print(f"æ€»è®¡: {len(results)} ä¸ªå®éªŒç›®çš„, {total_experiments} ä¸ªè®­ç»ƒå®éªŒ")
        print("="*80)

    def print_results_detail(self, purpose: str = None):
        """
        æ‰“å°è¯¦ç»†ç»“æœåˆ—è¡¨

        Args:
            purpose: æŒ‡å®šå®éªŒç›®çš„ï¼Œå¦‚æœä¸ºNoneåˆ™æ˜¾ç¤ºæ‰€æœ‰
        """
        results = self.scan_results()

        if not results:
            print("ğŸ“‚ Results_v2 ç›®å½•ä¸ºç©º")
            return

        # è¿‡æ»¤æŒ‡å®šçš„purpose
        if purpose:
            if purpose not in results:
                print(f"âŒ æœªæ‰¾åˆ°å®éªŒç›®çš„: {purpose}")
                print(f"å¯ç”¨çš„å®éªŒç›®çš„: {', '.join(sorted(results.keys()))}")
                return
            results = {purpose: results[purpose]}

        print("\n" + "="*80)
        print("è®­ç»ƒç»“æœè¯¦æƒ…")
        print("="*80)

        for purpose_name, experiments in sorted(results.items()):
            print(f"\nğŸ“ å®éªŒç›®çš„: {purpose_name}")
            print("-" * 80)

            for i, exp in enumerate(experiments, 1):
                print(f"\n  [{i}] {exp['experiment_name']}")
                print(f"      æ¨¡å‹: {exp['model']}")
                print(f"      æ—¶é—´: {exp['timestamp']}")
                print(f"      è·¯å¾„: {exp['path'].relative_to(self.project_root)}")

                if exp['config']:
                    config = exp['config']
                    print(f"      ä»»åŠ¡: {config.get('task', 'N/A')}")
                    print(f"      æ–¹æ³•: {config.get('method', 'N/A')}")

                    # æ˜¾ç¤ºè¶…å‚æ•°
                    hp = config.get('hyperparameters', {})
                    if hp:
                        print(f"      è¶…å‚æ•°:")
                        print(f"        - LR: {hp.get('learning_rate', 'N/A')}")
                        print(f"        - BS: {hp.get('batch_size', 'N/A')}")
                        print(f"        - Steps: {hp.get('steps', 'N/A')}")
                        print(f"        - Seed: {hp.get('seed', 'N/A')}")

                    # æ˜¾ç¤ºæ•°æ®ä¿¡æ¯
                    data_config = config.get('data', {})
                    if 'path' in data_config:
                        print(f"      æ•°æ®: {data_config['path']}")
                    elif 'type' in data_config:
                        print(f"      æ•°æ®: {data_config['type']}")

        print("\n" + "="*80)


def main():
    import argparse

    parser = argparse.ArgumentParser(description="è®­ç»ƒç»“æœç®¡ç†å·¥å…·")
    parser.add_argument(
        "--purpose",
        help="æŒ‡å®šå®éªŒç›®çš„ï¼ˆæŸ¥çœ‹è¯¦æƒ…æ—¶ä½¿ç”¨ï¼‰"
    )
    parser.add_argument(
        "--detail",
        action="store_true",
        help="æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯"
    )

    args = parser.parse_args()

    manager = ResultsManager()

    if args.detail:
        manager.print_results_detail(purpose=args.purpose)
    else:
        manager.print_results_summary()


if __name__ == "__main__":
    main()
