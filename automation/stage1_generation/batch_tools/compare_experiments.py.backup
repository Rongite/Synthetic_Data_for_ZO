#!/usr/bin/env python3
"""
æ¯”è¾ƒä¸åŒå®éªŒçš„å‚æ•°é…ç½®

ç”¨æ³•:
    # æ¯”è¾ƒä¸¤ä¸ªbatchä¸­çš„æ‰€æœ‰å®éªŒ
    python compare_experiments.py \
        --batch1 batch_20241229_temperature \
        --batch2 batch_20241230_topp

    # æ¯”è¾ƒåŒä¸€batchä¸­ä¸åŒæ•°æ®é›†
    python compare_experiments.py \
        --batch1 batch_20241229_temperature \
        --dataset1 Copa \
        --batch2 batch_20241229_temperature \
        --dataset2 CB

    # æ¯”è¾ƒ_shared/ä¸­çš„ä¸¤ä¸ªå…·ä½“å®éªŒ
    python compare_experiments.py \
        --shared Copa/temp07_topp10_gpt4o \
        --shared Copa/temp09_topp10_gpt4o
"""

import argparse
import json
import sys
from pathlib import Path

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from experiment_manager_batch import BatchExperimentManager

PROJECT_ROOT = "/home/ubuntu/LLM-inference/jikai-project/Synthetic_Data_for_ZO"


def compare_params(exp1, exp2):
    """æ¯”è¾ƒä¸¤ä¸ªå®éªŒçš„å‚æ•°"""
    differences = []
    similarities = []

    # è·å–å…ƒæ•°æ®
    meta1 = exp1.get('metadata', {})
    meta2 = exp2.get('metadata', {})

    # æ¯”è¾ƒç”Ÿæˆé…ç½®
    gen1 = meta1.get('generation', {})
    gen2 = meta2.get('generation', {})

    gen_fields = ['model', 'temperature', 'top_p', 'max_tokens']
    for field in gen_fields:
        val1 = gen1.get(field, 'N/A')
        val2 = gen2.get(field, 'N/A')

        if val1 != val2:
            differences.append({
                'field': f'generation.{field}',
                'exp1': val1,
                'exp2': val2
            })
        else:
            similarities.append({
                'field': f'generation.{field}',
                'value': val1
            })

    # æ¯”è¾ƒéªŒè¯é…ç½®
    val1 = meta1.get('validation', {})
    val2 = meta2.get('validation', {})

    val_fields = ['model', 'temperature']
    for field in val_fields:
        v1 = val1.get(field, 'N/A')
        v2 = val2.get(field, 'N/A')

        if v1 != v2:
            differences.append({
                'field': f'validation.{field}',
                'exp1': v1,
                'exp2': v2
            })
        else:
            similarities.append({
                'field': f'validation.{field}',
                'value': v1
            })

    return differences, similarities


def main():
    parser = argparse.ArgumentParser(
        description='æ¯”è¾ƒä¸åŒå®éªŒçš„å‚æ•°é…ç½®',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    parser.add_argument(
        '--batch1',
        help='ç¬¬ä¸€ä¸ªbatch ID'
    )
    parser.add_argument(
        '--dataset1',
        help='ç¬¬ä¸€ä¸ªbatchä¸­çš„æ•°æ®é›†åç§°'
    )
    parser.add_argument(
        '--batch2',
        help='ç¬¬äºŒä¸ªbatch ID'
    )
    parser.add_argument(
        '--dataset2',
        help='ç¬¬äºŒä¸ªbatchä¸­çš„æ•°æ®é›†åç§°'
    )
    parser.add_argument(
        '--shared',
        nargs=2,
        metavar=('EXP1', 'EXP2'),
        help='ç›´æ¥æ¯”è¾ƒ_shared/ä¸­çš„ä¸¤ä¸ªå®éªŒè·¯å¾„ (ä¾‹å¦‚: Copa/temp07_topp10_gpt4o)'
    )

    args = parser.parse_args()

    base_output_dir = Path(PROJECT_ROOT) / "Data_v2" / "synthetic"
    manager = BatchExperimentManager(base_output_dir)

    # è·å–å®éªŒåˆ—è¡¨
    if args.shared:
        # ç›´æ¥ä»_shared/è¯»å–
        shared_exps = manager.list_shared_experiments()

        exp1_path = args.shared[0]
        exp2_path = args.shared[1]

        exp1 = next((e for e in shared_exps if e['physical_path'] == f"_shared/{exp1_path}"), None)
        exp2 = next((e for e in shared_exps if e['physical_path'] == f"_shared/{exp2_path}"), None)

        if not exp1:
            print(f"âŒ å®éªŒ1ä¸å­˜åœ¨: {exp1_path}")
            return 1
        if not exp2:
            print(f"âŒ å®éªŒ2ä¸å­˜åœ¨: {exp2_path}")
            return 1

        exp1_name = exp1_path
        exp2_name = exp2_path

    elif args.batch1 and args.batch2:
        # ä»batchä¸­è¯»å–
        exps1 = manager.list_experiments_in_batch(args.batch1, args.dataset1)
        exps2 = manager.list_experiments_in_batch(args.batch2, args.dataset2)

        if not exps1:
            print(f"âŒ Batch1ä¸­æœªæ‰¾åˆ°å®éªŒ: {args.batch1}")
            return 1
        if not exps2:
            print(f"âŒ Batch2ä¸­æœªæ‰¾åˆ°å®éªŒ: {args.batch2}")
            return 1

        print("\né€‰æ‹©è¦æ¯”è¾ƒçš„å®éªŒ:")
        print(f"\nBatch1: {args.batch1}")
        for i, e in enumerate(exps1):
            print(f"  {i+1}. {e['dataset']}/{e['exp_name']}")

        print(f"\nBatch2: {args.batch2}")
        for i, e in enumerate(exps2):
            print(f"  {i+1}. {e['dataset']}/{e['exp_name']}")

        # ç®€åŒ–ï¼šå¦‚æœåªæœ‰ä¸€ä¸ªå®éªŒï¼Œè‡ªåŠ¨é€‰æ‹©
        if len(exps1) == 1 and len(exps2) == 1:
            exp1 = exps1[0]
            exp2 = exps2[0]
        else:
            print("\nåŠŸèƒ½å¾…å®ç°ï¼šè¯·ä½¿ç”¨--sharedç›´æ¥æŒ‡å®šå®éªŒ")
            return 1

        exp1_name = f"{args.batch1}/{exp1['dataset']}/{exp1['exp_name']}"
        exp2_name = f"{args.batch2}/{exp2['dataset']}/{exp2['exp_name']}"

        # è¯»å–ç‰©ç†è·¯å¾„çš„å…ƒæ•°æ®
        exp1_metadata_path = base_output_dir / exp1['physical_path'].replace('_shared/', '') / 'experiment_metadata.json'
        exp2_metadata_path = base_output_dir / exp2['physical_path'].replace('_shared/', '') / 'experiment_metadata.json'

        if exp1_metadata_path.exists():
            with open(exp1_metadata_path, 'r') as f:
                exp1['metadata'] = json.load(f)

        if exp2_metadata_path.exists():
            with open(exp2_metadata_path, 'r') as f:
                exp2['metadata'] = json.load(f)

    else:
        parser.print_help()
        return 1

    # æ¯”è¾ƒå‚æ•°
    differences, similarities = compare_params(exp1, exp2)

    print("\n" + "=" * 80)
    print("å®éªŒå‚æ•°æ¯”è¾ƒ")
    print("=" * 80)
    print(f"\nå®éªŒ1: {exp1_name}")
    print(f"å®éªŒ2: {exp2_name}")

    # æ˜¾ç¤ºç›¸åŒå‚æ•°
    if similarities:
        print("\nâœ… ç›¸åŒå‚æ•°:")
        for item in similarities:
            print(f"  {item['field']}: {item['value']}")

    # æ˜¾ç¤ºä¸åŒå‚æ•°
    if differences:
        print("\nâš ï¸  ä¸åŒå‚æ•°:")
        for item in differences:
            print(f"  {item['field']}:")
            print(f"    å®éªŒ1: {item['exp1']}")
            print(f"    å®éªŒ2: {item['exp2']}")
    else:
        print("\nâœ… æ‰€æœ‰å‚æ•°å®Œå…¨ç›¸åŒ")
        print(f"å‚æ•°æŒ‡çº¹: {exp1.get('fingerprint', 'N/A')}")

    # åˆ¤æ–­æ˜¯å¦åº”è¯¥å…±äº«ç‰©ç†æ•°æ®
    if exp1.get('fingerprint') == exp2.get('fingerprint'):
        print("\nğŸ’¾ æç¤º: è¿™ä¸¤ä¸ªå®éªŒçš„å‚æ•°æŒ‡çº¹ç›¸åŒï¼Œåº”è¯¥å…±äº«ç‰©ç†æ•°æ®")
    else:
        print(f"\nğŸ”§ æç¤º: å‚æ•°ä¸åŒï¼Œéœ€è¦å•ç‹¬ç”Ÿæˆæ•°æ®")
        print(f"  å®éªŒ1æŒ‡çº¹: {exp1.get('fingerprint', 'N/A')}")
        print(f"  å®éªŒ2æŒ‡çº¹: {exp2.get('fingerprint', 'N/A')}")

    print()
    return 0


if __name__ == '__main__':
    exit(main())
