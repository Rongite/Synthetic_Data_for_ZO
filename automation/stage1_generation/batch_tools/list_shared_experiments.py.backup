#!/usr/bin/env python3
"""
åˆ—å‡º_shared/ä¸­çš„æ‰€æœ‰ç‰©ç†å®éªŒæ•°æ®

ç”¨æ³•:
    python list_shared_experiments.py
    python list_shared_experiments.py --dataset Copa
    python list_shared_experiments.py --verbose
"""

import argparse
import json
import sys
from pathlib import Path

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from experiment_manager_batch import BatchExperimentManager

PROJECT_ROOT = "/home/ubuntu/LLM-inference/jikai-project/Synthetic_Data_for_ZO"


def main():
    parser = argparse.ArgumentParser(
        description='åˆ—å‡º_shared/ä¸­çš„æ‰€æœ‰ç‰©ç†å®éªŒæ•°æ®',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  # åˆ—å‡ºæ‰€æœ‰ç‰©ç†å®éªŒ
  python list_shared_experiments.py

  # åªåˆ—å‡ºCopaæ•°æ®é›†çš„å®éªŒ
  python list_shared_experiments.py --dataset Copa

  # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ã€å‚æ•°æŒ‡çº¹ç­‰ï¼‰
  python list_shared_experiments.py --verbose
        """
    )
    parser.add_argument(
        '--dataset',
        help='åªæ˜¾ç¤ºæŒ‡å®šæ•°æ®é›†çš„å®éªŒ'
    )
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ã€å‚æ•°é…ç½®ç­‰ï¼‰'
    )
    args = parser.parse_args()

    base_output_dir = Path(PROJECT_ROOT) / "Data_v2" / "synthetic"
    manager = BatchExperimentManager(base_output_dir)

    experiments = manager.list_shared_experiments(args.dataset)

    if not experiments:
        print(f"\nåœ¨ _shared/ ä¸­æœªæ‰¾åˆ°å®éªŒ")
        if args.dataset:
            print(f"(æ•°æ®é›†: {args.dataset})")
        return 0

    print("\n" + "=" * 80)
    print("_shared/ ä¸­çš„ç‰©ç†å®éªŒæ•°æ®")
    if args.dataset:
        print(f"æ•°æ®é›†: {args.dataset}")
    print(f"å®éªŒæ•°: {len(experiments)}")
    print("=" * 80)

    # æŒ‰æ•°æ®é›†åˆ†ç»„
    by_dataset = {}
    for exp in experiments:
        dataset = exp['dataset']
        if dataset not in by_dataset:
            by_dataset[dataset] = []
        by_dataset[dataset].append(exp)

    for dataset, exps in by_dataset.items():
        print(f"\nğŸ“Š {dataset} ({len(exps)} ä¸ªå®éªŒ)")
        print("-" * 80)

        for exp in exps:
            print(f"\n  ğŸ“¦ {exp['exp_name']}")
            print(f"     ç‰©ç†è·¯å¾„: {exp['physical_path']}")
            print(f"     å‚æ•°æŒ‡çº¹: {exp.get('fingerprint', 'N/A')[:12]}...")
            print(f"     åˆ›å»ºæ—¶é—´: {exp.get('created_at', 'N/A')}")
            print(f"     åŸå§‹Batch: {exp.get('batch_id', 'N/A')}")

            if args.verbose and 'metadata' in exp:
                metadata = exp['metadata']

                # æ˜¾ç¤ºç”Ÿæˆé…ç½®
                if 'generation' in metadata:
                    gen = metadata['generation']
                    print(f"\n     ç”Ÿæˆé…ç½®:")
                    print(f"       æ¨¡å‹: {gen.get('model', 'N/A')}")
                    print(f"       Temperature: {gen.get('temperature', 'N/A')}")
                    print(f"       Top_p: {gen.get('top_p', 'N/A')}")
                    print(f"       Max tokens: {gen.get('max_tokens', 'N/A')}")

                # æ˜¾ç¤ºéªŒè¯é…ç½®
                if 'validation' in metadata:
                    val = metadata['validation']
                    print(f"\n     éªŒè¯é…ç½®:")
                    print(f"       æ¨¡å‹: {val.get('model', 'N/A')}")
                    print(f"       Temperature: {val.get('temperature', 'N/A')}")

                # æ˜¾ç¤ºå®éªŒä¿¡æ¯
                if 'experiment_purpose' in metadata:
                    print(f"\n     å®éªŒç›®çš„: {metadata.get('experiment_purpose', 'N/A')}")
                if 'experiment_description' in metadata:
                    print(f"     å®éªŒæè¿°: {metadata.get('experiment_description', 'N/A')}")

    print()
    return 0


if __name__ == '__main__':
    exit(main())
