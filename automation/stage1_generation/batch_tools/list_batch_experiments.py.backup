#!/usr/bin/env python3
"""
åˆ—å‡ºæŒ‡å®šbatchä¸­çš„æ‰€æœ‰å®éªŒ

ç”¨æ³•:
    python list_batch_experiments.py batch_20241229_temperature
    python list_batch_experiments.py batch_20241229_temperature --dataset Copa
    python list_batch_experiments.py batch_20241229_temperature --verbose
"""

import argparse
import json
import sys
from pathlib import Path

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„
sys.path.insert(0, str(Path(__file__).parent.parent))

from experiment_manager_batch import BatchExperimentManager

PROJECT_ROOT = "/home/ubuntu/LLM-inference/jikai-project/Synthetic_Data_for_ZO"


def main():
    parser = argparse.ArgumentParser(
        description='åˆ—å‡ºæŒ‡å®šbatchä¸­çš„æ‰€æœ‰å®éªŒ',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  # åˆ—å‡ºbatchä¸­çš„æ‰€æœ‰å®éªŒ
  python list_batch_experiments.py batch_20241229_temperature

  # åªåˆ—å‡ºCopaæ•°æ®é›†çš„å®éªŒ
  python list_batch_experiments.py batch_20241229_temperature --dataset Copa

  # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ï¼‰
  python list_batch_experiments.py batch_20241229_temperature --verbose
        """
    )
    parser.add_argument(
        'batch_id',
        help='Batch ID (ä¾‹å¦‚: batch_20241229_temperature)'
    )
    parser.add_argument(
        '--dataset',
        help='åªæ˜¾ç¤ºæŒ‡å®šæ•°æ®é›†çš„å®éªŒ'
    )
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬å…ƒæ•°æ®ã€ç‰©ç†è·¯å¾„ç­‰ï¼‰'
    )
    args = parser.parse_args()

    base_output_dir = Path(PROJECT_ROOT) / "Data_v2" / "synthetic"
    manager = BatchExperimentManager(base_output_dir)

    # æ£€æŸ¥batchæ˜¯å¦å­˜åœ¨
    batch_dir = base_output_dir / args.batch_id
    if not batch_dir.exists():
        print(f"âŒ Batchä¸å­˜åœ¨: {args.batch_id}")
        print(f"\nå¯ç”¨çš„batch:")
        for batch in manager.list_batches():
            print(f"  - {batch}")
        return 1

    experiments = manager.list_experiments_in_batch(args.batch_id, args.dataset)

    if not experiments:
        print(f"\nåœ¨ {args.batch_id} ä¸­æœªæ‰¾åˆ°å®éªŒ")
        if args.dataset:
            print(f"(æ•°æ®é›†: {args.dataset})")
        return 0

    print("\n" + "=" * 80)
    print(f"Batch: {args.batch_id}")
    if args.dataset:
        print(f"æ•°æ®é›†: {args.dataset}")
    print(f"å®éªŒæ•°: {len(experiments)}")
    print("=" * 80)

    # æŒ‰æ•°æ®é›†åˆ†ç»„
    by_dataset = {}
    for exp in experiments:
        dataset = exp['dataset']
        if dataset not in by_dataset:
            by_dataset[dataset] = []
        by_dataset[dataset].append(exp)

    for dataset, exps in by_dataset.items():
        print(f"\nğŸ“Š {dataset} ({len(exps)} ä¸ªå®éªŒ)")
        print("-" * 80)

        for exp in exps:
            print(f"\n  ğŸ”§ {exp['exp_name']}")
            print(f"     Batchè§†å›¾: {exp['link_path']}")

            if args.verbose:
                print(f"     ç‰©ç†å­˜å‚¨: {exp['physical_path']}")
                print(f"     åˆ›å»ºæ—¶é—´: {exp.get('created_at', 'N/A')}")
                print(f"     å‚æ•°æŒ‡çº¹: {exp.get('fingerprint', 'N/A')}")

                if exp.get('is_reused'):
                    print(f"     âš¡ æ•°æ®å¤ç”¨: æ˜¯ (åŸbatch: {exp.get('original_batch', 'N/A')})")
                else:
                    print(f"     âš¡ æ•°æ®å¤ç”¨: å¦ (æ–°ç”Ÿæˆ)")

                # æ˜¾ç¤ºå…ƒæ•°æ®ä¸­çš„å…³é”®ä¿¡æ¯
                if 'metadata' in exp:
                    metadata = exp['metadata']
                    if 'generation' in metadata:
                        gen = metadata['generation']
                        print(f"     ç”Ÿæˆæ¨¡å‹: {gen.get('model', 'N/A')}")
                        print(f"     Temperature: {gen.get('temperature', 'N/A')}")
                        print(f"     Top_p: {gen.get('top_p', 'N/A')}")

    print()
    return 0


if __name__ == '__main__':
    exit(main())
